<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>UserPage</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="alert alert-primary text-center">
                <h3 id="welcomeMessage">ì•ˆë…•í•˜ì„¸ìš”! ì‚¬ìš©ìë‹˜!</h3>
            </div>

            <div id="loadingSpinner" class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>

            <div id="userInfoCard" class="card" style="display: none;">
                <div class="card-header">
                    <h5 class="card-title mb-0">ë‚´ ì •ë³´</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-sm-4">
                            <strong>ì´ë©”ì¼ (Email)</strong>
                        </div>
                        <div class="col-sm-8" id="userEmail">-</div>
                    </div>
                    <hr>
                    <div class="row mb-3">
                        <div class="col-sm-4">
                            <strong>ë‹‰ë„¤ì„ (Nickname)</strong>
                        </div>
                        <div class="col-sm-8" id="userNickname">-</div>
                    </div>
                    <hr>
                    <div class="row mb-3">
                        <div class="col-sm-4">
                            <strong>ì´ë¦„ (Name)</strong>
                        </div>
                        <div class="col-sm-8" id="userName">-</div>
                    </div>
                    <hr>
                    <div class="row mb-0">
                        <div class="col-sm-4">
                            <strong>ì „í™”ë²ˆí˜¸ (Phone Number)</strong>
                        </div>
                        <div class="col-sm-8" id="userPhone">-</div>
                    </div>
                </div>
            </div>

            <div id="errorMessage" class="alert alert-danger" style="display: none;">
                <h5>ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</h5>
                <p id="errorText">ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                <button class="btn btn-primary" onclick="loadUserInfo()">ë‹¤ì‹œ ì‹œë„</button>
            </div>

            <div class="text-center mt-4">
                <button class="btn btn-warning btn-lg me-3" id="adminBtn" style="display: none;">
                    ğŸ”§ ê´€ë¦¬ì í˜ì´ì§€
                </button>
                <button class="btn btn-outline-danger btn-lg" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const token = localStorage.getItem('accessToken');

        if (!token) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/login';
            return;
        }

        loadUserInfo();
    });

    function loadUserInfo() {
        const token = localStorage.getItem('accessToken');

        if (!token) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/login';
            return;
        }

        document.getElementById('loadingSpinner').style.display = 'flex';
        document.getElementById('userInfoCard').style.display = 'none';
        document.getElementById('errorMessage').style.display = 'none';

        fetch('/api/v1/users/me', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (response.status === 401) {
                    alert('ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('userEmail');
                    window.location.href = '/login';
                    return null;
                }

                if (response.status === 403) {
                    alert('ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                    window.location.href = '/login';
                    return null;
                }

                return response.json();
            })
            .then(data => {
                if (data === null) return; // 401, 403 ì—ëŸ¬ ì‹œ early return

                if (data && data.success) {
                    displayUserInfo(data.data);
                } else {
                    showError(data?.message || 'ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
    }

    function displayUserInfo(user) {
        document.getElementById('loadingSpinner').style.display = 'none';

        document.getElementById('welcomeMessage').textContent = `ì•ˆë…•í•˜ì„¸ìš”! ${user.nickname || user.username || 'ì‚¬ìš©ì'}ë‹˜!`;

        document.getElementById('userEmail').textContent = user.email || '-';
        document.getElementById('userNickname').textContent = user.nickname || '-';
        document.getElementById('userName').textContent = user.username || '-';
        document.getElementById('userPhone').textContent = user.phone || '-';
        if (user.role === 'ROLE_ADMIN') {
            document.getElementById('adminBtn').style.display = 'inline-block';
            document.getElementById('adminBtn').onclick = () => window.location.href = '/admin';
        }
        document.getElementById('userInfoCard').style.display = 'block';
    }

    function showError(message) {
        document.getElementById('loadingSpinner').style.display = 'none';
        document.getElementById('userInfoCard').style.display = 'none';
        document.getElementById('errorText').textContent = message;
        document.getElementById('errorMessage').style.display = 'block';
    }

    document.getElementById('logoutBtn').addEventListener('click', function() {
        if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            performLogout();
        }
    });

    function performLogout() {
        const token = localStorage.getItem('accessToken');

        if (!token) {
            cleanupClientData();
            return;
        }

        fetch('/api/v1/auth/logout', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    console.log('ì„œë²„ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨, ìƒíƒœì½”ë“œ:', response.status);
                    return null;
                }
            })
            .then(data => {
                if (data && data.success) {
                    console.log('ì„œë²„ ë¡œê·¸ì•„ì›ƒ ì„±ê³µ');
                } else {
                    console.log('ì„œë²„ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', data?.message || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('ë¡œê·¸ì•„ì›ƒ ìš”ì²­ ì˜¤ë¥˜:', error);
            })
            .finally(() => {
                cleanupClientData();
            });
    }

    function cleanupClientData() {
        localStorage.removeItem('accessToken');
        localStorage.removeItem('userEmail');

        alert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
        window.location.href = '/login';
    }
</script>
</body>
</html>