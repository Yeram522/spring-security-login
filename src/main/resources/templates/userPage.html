<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>UserPage</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="alert alert-primary text-center">
                <h3 id="welcomeMessage">안녕하세요! 사용자님!</h3>
            </div>

            <div id="loadingSpinner" class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>

            <div id="userInfoCard" class="card" style="display: none;">
                <div class="card-header">
                    <h5 class="card-title mb-0">내 정보</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-sm-4">
                            <strong>이메일 (Email)</strong>
                        </div>
                        <div class="col-sm-8" id="userEmail">-</div>
                    </div>
                    <hr>
                    <div class="row mb-3">
                        <div class="col-sm-4">
                            <strong>닉네임 (Nickname)</strong>
                        </div>
                        <div class="col-sm-8" id="userNickname">-</div>
                    </div>
                    <hr>
                    <div class="row mb-3">
                        <div class="col-sm-4">
                            <strong>이름 (Name)</strong>
                        </div>
                        <div class="col-sm-8" id="userName">-</div>
                    </div>
                    <hr>
                    <div class="row mb-0">
                        <div class="col-sm-4">
                            <strong>전화번호 (Phone Number)</strong>
                        </div>
                        <div class="col-sm-8" id="userPhone">-</div>
                    </div>
                </div>
            </div>

            <div id="errorMessage" class="alert alert-danger" style="display: none;">
                <h5>오류가 발생했습니다</h5>
                <p id="errorText">사용자 정보를 불러올 수 없습니다.</p>
                <button class="btn btn-primary" onclick="loadUserInfo()">다시 시도</button>
            </div>

            <div class="text-center mt-4">
                <button class="btn btn-outline-danger btn-lg" id="logoutBtn">로그아웃</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const token = localStorage.getItem('accessToken');

        if (!token) {
            alert('로그인이 필요합니다.');
            window.location.href = '/login';
            return;
        }

        loadUserInfo();
    });

    function loadUserInfo() {
        const token = localStorage.getItem('accessToken');

        if (!token) {
            alert('로그인이 필요합니다.');
            window.location.href = '/login';
            return;
        }

        document.getElementById('loadingSpinner').style.display = 'flex';
        document.getElementById('userInfoCard').style.display = 'none';
        document.getElementById('errorMessage').style.display = 'none';

        fetch('/api/v1/users/me', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (response.status === 401) {
                    alert('로그인이 만료되었습니다. 다시 로그인해주세요.');
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('userEmail');
                    window.location.href = '/login';
                    return null;
                }

                if (response.status === 403) {
                    alert('접근 권한이 없습니다.');
                    window.location.href = '/login';
                    return null;
                }

                return response.json();
            })
            .then(data => {
                if (data === null) return; // 401, 403 에러 시 early return

                if (data && data.success) {
                    displayUserInfo(data.data);
                } else {
                    showError(data?.message || '사용자 정보를 불러오는데 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('네트워크 오류가 발생했습니다.');
            });
    }

    function displayUserInfo(user) {
        document.getElementById('loadingSpinner').style.display = 'none';

        document.getElementById('welcomeMessage').textContent = `안녕하세요! ${user.nickname || user.username || '사용자'}님!`;

        document.getElementById('userEmail').textContent = user.email || '-';
        document.getElementById('userNickname').textContent = user.nickname || '-';
        document.getElementById('userName').textContent = user.username || '-';
        document.getElementById('userPhone').textContent = user.phone || '-';

        document.getElementById('userInfoCard').style.display = 'block';
    }

    function showError(message) {
        document.getElementById('loadingSpinner').style.display = 'none';
        document.getElementById('userInfoCard').style.display = 'none';
        document.getElementById('errorText').textContent = message;
        document.getElementById('errorMessage').style.display = 'block';
    }

    document.getElementById('logoutBtn').addEventListener('click', function() {
        if (confirm('로그아웃 하시겠습니까?')) {
            performLogout();
        }
    });

    function performLogout() {
        const token = localStorage.getItem('accessToken');

        if (!token) {
            cleanupClientData();
            return;
        }

        fetch('/api/v1/auth/logout', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    console.log('서버 로그아웃 실패, 상태코드:', response.status);
                    return null;
                }
            })
            .then(data => {
                if (data && data.success) {
                    console.log('서버 로그아웃 성공');
                } else {
                    console.log('서버 로그아웃 실패:', data?.message || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('로그아웃 요청 오류:', error);
            })
            .finally(() => {
                cleanupClientData();
            });
    }

    function cleanupClientData() {
        localStorage.removeItem('accessToken');
        localStorage.removeItem('userEmail');

        alert('로그아웃되었습니다.');
        window.location.href = '/login';
    }
</script>
</body>
</html>