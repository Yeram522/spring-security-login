<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Find Password</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .step-section {
            display: none;
        }
        .step-section.active {
            display: block;
        }
        .error-text {
            color: #dc3545;
            font-size: 0.875rem;
        }
        .success-text {
            color: #198754;
            font-size: 0.875rem;
        }
        .progress-steps {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        .progress-step {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            font-weight: bold;
            color: #6c757d;
        }
        .progress-step.active {
            background-color: #0d6efd;
            color: white;
        }
        .progress-step.completed {
            background-color: #198754;
            color: white;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3>비밀번호 찾기</h3>
                </div>
                <div class="card-body">
                    <div class="progress-steps">
                        <div class="progress-step active" id="step1-indicator">1</div>
                        <div class="progress-step" id="step2-indicator">2</div>
                        <div class="progress-step" id="step3-indicator">3</div>
                    </div>

                    <div id="step1" class="step-section active">
                        <h5 class="mb-3">1단계: 이메일 인증</h5>
                        <div class="mb-3">
                            <label for="email" class="form-label">이메일</label>
                            <div class="input-group">
                                <input type="email" class="form-control" id="email" placeholder="가입한 이메일을 입력하세요" required>
                                <button type="button" class="btn btn-outline-primary" id="sendCodeBtn">인증요청</button>
                            </div>
                            <div id="emailMessage" class="mt-1"></div>
                        </div>

                        <div id="verificationSection" style="display: none;">
                            <div class="mb-3">
                                <label for="verificationCode" class="form-label">인증번호</label>
                                <input type="text" class="form-control" id="verificationCode" placeholder="6자리 인증번호 입력" maxlength="6">
                                <div id="verificationMessage" class="mt-1"></div>
                            </div>
                            <button type="button" class="btn btn-success w-100" id="verifyCodeBtn">인증 확인</button>
                        </div>
                    </div>

                    <div id="step2" class="step-section">
                        <h5 class="mb-3">2단계: 새 비밀번호 설정</h5>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">새 비밀번호</label>
                            <input type="password" class="form-control" id="newPassword" placeholder="새 비밀번호를 입력하세요" required>
                            <div class="form-text">8자 이상, 영문, 숫자, 특수문자를 포함해주세요.</div>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">비밀번호 확인</label>
                            <input type="password" class="form-control" id="confirmPassword" placeholder="비밀번호를 다시 입력하세요" required>
                            <div id="passwordMessage" class="mt-1"></div>
                        </div>
                        <button type="button" class="btn btn-primary w-100" id="resetPasswordBtn">비밀번호 재설정</button>
                    </div>

                    <div id="step3" class="step-section">
                        <div class="text-center">
                            <div class="mb-4">
                                <i class="bi bi-check-circle-fill" style="font-size: 4rem; color: #198754;"></i>
                            </div>
                            <h5 class="mb-3">비밀번호 재설정 완료!</h5>
                            <p class="text-muted mb-4">새로운 비밀번호로 로그인해주세요.</p>
                            <button type="button" class="btn btn-success w-100" id="goToLoginBtn">로그인 페이지로 이동</button>
                        </div>
                    </div>

                    <div class="text-center mt-3">
                        <a href="/login" class="btn btn-link">로그인 페이지로 돌아가기</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentStep = 1;
    let verifiedEmail = '';

    function showStep(step) {
        document.querySelectorAll('.step-section').forEach(section => {
            section.classList.remove('active');
        });

        document.getElementById(`step${step}`).classList.add('active');

        document.querySelectorAll('.progress-step').forEach((indicator, index) => {
            indicator.classList.remove('active', 'completed');
            if (index + 1 < step) {
                indicator.classList.add('completed');
            } else if (index + 1 === step) {
                indicator.classList.add('active');
            }
        });

        currentStep = step;
    }

    document.getElementById('sendCodeBtn').addEventListener('click', function() {
        const email = document.getElementById('email').value;
        if (!email) {
            alert('이메일을 입력해주세요.');
            return;
        }

        const btn = this;
        btn.disabled = true;
        btn.textContent = '발송 중...';

        fetch('/api/v1/auth/email/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                purpose: "password-reset",
                email: email
            })
        })
            .then(response => response.json())
            .then(data => {
                const messageDiv = document.getElementById('emailMessage');
                if (data.success) {
                    messageDiv.innerHTML = '<span class="success-text">인증번호가 발송되었습니다.</span>';
                    document.getElementById('verificationSection').style.display = 'block';
                    verifiedEmail = email;
                } else {
                    messageDiv.innerHTML = `<span class="error-text">${data.message || '인증번호 발송에 실패했습니다.'}</span>`;
                    alert(data.message || '인증번호 발송에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('emailMessage').innerHTML = '<span class="error-text">오류가 발생했습니다.</span>';
                alert('오류가 발생했습니다.');
            })
            .finally(() => {
                btn.disabled = false;
                btn.textContent = '인증요청';
            });
    });

    document.getElementById('verifyCodeBtn').addEventListener('click', function() {
        const verificationCode = document.getElementById('verificationCode').value;
        if (!verificationCode) {
            alert('인증번호를 입력해주세요.');
            return;
        }

        fetch('/api/v1/auth/email/verify', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                purpose: 'password-reset',
                email: verifiedEmail,
                verificationCode: verificationCode
            })
        })
            .then(response => response.json())
            .then(data => {
                const messageDiv = document.getElementById('verificationMessage');
                if (data.success) {
                    messageDiv.innerHTML = '<span class="success-text">인증이 완료되었습니다!</span>';
                    setTimeout(() => {
                        showStep(2);
                    }, 1000);
                } else {
                    messageDiv.innerHTML = `<span class="error-text">${data.message || '인증번호가 일치하지 않습니다.'}</span>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('verificationMessage').innerHTML = '<span class="error-text">인증 확인 중 오류가 발생했습니다.</span>';
            });
    });

    document.getElementById('confirmPassword').addEventListener('input', function() {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = this.value;
        const messageDiv = document.getElementById('passwordMessage');

        if (confirmPassword && newPassword !== confirmPassword) {
            messageDiv.innerHTML = '<span class="error-text">비밀번호가 일치하지 않습니다.</span>';
        } else if (confirmPassword && newPassword === confirmPassword) {
            messageDiv.innerHTML = '<span class="success-text">비밀번호가 일치합니다.</span>';
        } else {
            messageDiv.innerHTML = '';
        }
    });

    document.getElementById('resetPasswordBtn').addEventListener('click', function() {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (!newPassword || !confirmPassword) {
            alert('모든 필드를 입력해주세요.');
            return;
        }

        if (newPassword !== confirmPassword) {
            alert('비밀번호가 일치하지 않습니다.');
            return;
        }

        if (newPassword.length < 8) {
            alert('비밀번호는 8자 이상이어야 합니다.');
            return;
        }

        const btn = this;
        btn.disabled = true;
        btn.textContent = '재설정 중...';

        fetch('/api/v1/users/password', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: verifiedEmail,
                newPassword: newPassword
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showStep(3);
                } else {
                    alert('비밀번호 재설정에 실패했습니다: ' + (data.message || ''));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('비밀번호 재설정 중 오류가 발생했습니다.');
            })
            .finally(() => {
                btn.disabled = false;
                btn.textContent = '비밀번호 재설정';
            });
    });

    document.getElementById('goToLoginBtn').addEventListener('click', function() {
        alert('비밀번호가 성공적으로 재설정되었습니다!');
        window.location.href = '/login';
    });
</script>
</body>
</html>