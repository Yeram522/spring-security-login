<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Register</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .error-text {
            color: #dc3545;
            font-size: 0.875rem;
        }
        .success-text {
            color: #198754;
            font-size: 0.875rem;
        }
        .verification-section {
            display: none;
            margin-top: 10px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3>Register</h3>
                </div>
                <div class="card-body">
                    <form th:action="@{/register}" th:object="${user}" method="post" id="registerForm">
                        <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username" th:field="*{username}" required>
                        </div>
                        <div class="mb-3">
                            <label for="nickname" class="form-label">Nickname</label>
                            <input type="text" class="form-control" id="nickname" th:field="*{nickname}" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <div class="input-group">
                                <input type="email" class="form-control" id="email" th:field="*{email}" required>
                                <button type="button" class="btn btn-outline-secondary" id="checkDuplicateBtn">중복 확인</button>
                            </div>
                            <div id="emailMessage" class="mt-1"></div>

                            <!-- 이메일 인증 섹션 -->
                            <div id="verificationSection" class="verification-section">
                                <div class="mb-2">
                                    <button type="button" class="btn btn-primary btn-sm" id="sendVerificationBtn">인증번호 발송</button>
                                    <span id="sendMessage" class="ms-2"></span>
                                </div>
                                <div class="mb-2">
                                    <input type="text" class="form-control" id="verificationCode" placeholder="인증번호 6자리 입력" maxlength="6">
                                    <button type="button" class="btn btn-success btn-sm mt-2" id="verifyCodeBtn">인증 확인</button>
                                </div>
                                <div id="verificationMessage" class="mt-1"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="phone" th:field="*{phone}"
                                   pattern="010-[0-9]{4}-[0-9]{4}"
                                   title="010-xxxx-xxxx 형식으로 입력해주세요"
                                   placeholder="010-1234-5678" maxlength="13" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" th:field="*{password}" required>
                        </div>
                        <button type="submit" class="btn btn-primary" id="registerBtn">Register</button>
                        <a href="/login" class="btn btn-link">Already have an account? Login</a>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let isEmailDuplicateChecked = false;
    let isEmailVerified = false;

    // 전화번호 자동 포맷팅
    document.getElementById('phone').addEventListener('input', function(e) {
        let value = e.target.value.replace(/[^0-9]/g, '');

        if (!value.startsWith('010')) {
            if (value.length > 0) {
                value = '010' + value;
            } else {
                value = '010';
            }
        }

        if (value.length >= 3 && value.length <= 7) {
            value = value.substring(0, 3) + '-' + value.substring(3);
        } else if (value.length > 7) {
            value = value.substring(0, 3) + '-' + value.substring(3, 7) + '-' + value.substring(7, 11);
        }

        e.target.value = value;
    });

    // 페이지 로드 시 010- 미리 입력
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('phone').value = '010-';
    });

    // 이메일 변경 시 상태 초기화
    document.getElementById('email').addEventListener('input', function() {
        isEmailDuplicateChecked = false;
        isEmailVerified = false;
        document.getElementById('emailMessage').innerHTML = '';
        document.getElementById('verificationSection').style.display = 'none';
        document.getElementById('verificationMessage').innerHTML = '';
    });

    // 이메일 중복 확인
    document.getElementById('checkDuplicateBtn').addEventListener('click', function() {
        const email = document.getElementById('email').value;
        if (!email) {
            alert('이메일을 입력해주세요.');
            return;
        }

        fetch(`/api/users?email=${encodeURIComponent(email)}`)
            .then(response => response.json())
            .then(data => {
                const messageDiv = document.getElementById('emailMessage');
                if (data.exists) {
                    messageDiv.innerHTML = '<span class="error-text">이미 존재하는 이메일입니다.</span>';
                    isEmailDuplicateChecked = false;
                    document.getElementById('verificationSection').style.display = 'none';
                } else {
                    messageDiv.innerHTML = '<span class="success-text">사용 가능한 이메일입니다.</span>';
                    isEmailDuplicateChecked = true;
                    document.getElementById('verificationSection').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('emailMessage').innerHTML = '<span class="error-text">중복 확인 중 오류가 발생했습니다.</span>';
            });
    });

    // 인증번호 발송
    document.getElementById('sendVerificationBtn').addEventListener('click', function() {
        const email = document.getElementById('email').value;

        fetch('/api/email-verification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'send',
                purpose: "signup",
                email: email
            })
        })
            .then(response => response.json())
            .then(data => {
                const sendMessageSpan = document.getElementById('sendMessage');
                if (data.success) {
                    sendMessageSpan.innerHTML = '<span class="success-text">인증번호가 발송되었습니다.</span>';
                } else {
                    sendMessageSpan.innerHTML = '<span class="error-text">인증번호 발송에 실패했습니다.</span>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('sendMessage').innerHTML = '<span class="error-text">인증번호 발송 중 오류가 발생했습니다.</span>';
            });
    });

    // 인증번호 확인
    document.getElementById('verifyCodeBtn').addEventListener('click', function() {
        const email = document.getElementById('email').value;
        const verificationCode = document.getElementById('verificationCode').value;

        if (!verificationCode) {
            alert('인증번호를 입력해주세요.');
            return;
        }

        fetch('/api/email-verification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'verify',
                purpose: "signup",
                email: email,
                verificationCode: verificationCode
            })
        })
            .then(response => response.json())
            .then(data => {
                const verificationMessageDiv = document.getElementById('verificationMessage');
                if (data.success) {
                    verificationMessageDiv.innerHTML = '<span class="success-text">이메일 인증이 완료되었습니다!</span>';
                    isEmailVerified = true;
                    alert('이메일 인증이 완료되었습니다!');
                } else {
                    verificationMessageDiv.innerHTML = '<span class="error-text">인증번호가 일치하지 않습니다.</span>';
                    isEmailVerified = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('verificationMessage').innerHTML = '<span class="error-text">인증 확인 중 오류가 발생했습니다.</span>';
            });
    });

    // 회원가입 폼 제출 시 검증
    document.getElementById('registerForm').addEventListener('submit', function(e) {
        e.preventDefault(); // 기본 폼 제출 막기

        if (!isEmailDuplicateChecked) {
            alert('이메일 중복 확인을 해주세요.');
            return;
        }

        if (!isEmailVerified) {
            alert('이메일 인증을 완료해주세요.');
            return;
        }

        // 모든 검증 통과 시 회원가입 API 호출
        const formData = {
            username: document.getElementById('username').value,
            nickname: document.getElementById('nickname').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            password: document.getElementById('password').value
        };

        fetch('/api/users', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('회원가입이 완료되었습니다!');
                    window.location.href = '/login'; // ⭐ 로그인 페이지로 리다이렉트
                } else {
                    alert('회원가입에 실패했습니다: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('회원가입 중 오류가 발생했습니다.');
            });
    });
</script>
</body>
</html>